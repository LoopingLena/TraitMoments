---
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#library(tidyverse)
```

# TraitMoments

Efficient calculation of trait distribution moments.

<!-- badges: start -->
[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://www.tidyverse.org/lifecycle/#experimental)
<!-- badges: end -->

TraitMoments provides an efficient function to calculate all moments (mean, variance, skewness and kurtosis) of trait distribution across large community and traits datasets. The calculation is performed according to the equations number 1 to 4 from Le Bagousse-Pinguet et al. (2017): 

\[
\small
Mean_{j} = \sum_{i}^{n} p_i T_i
\tag{1}
\]  


\[
\small
Variance_{j} = \sum_{i}^{n} p_i (T_i - Mean_j)^2
\tag{2}
\]  


\[
\small
Skewness_{j} = \sum_{i}^{n} \frac{p_i (T_i - Mean_j)^3}{Variance_j^{\frac{3}{2}}}
\tag{3}
\]  


\[
\small
Kurtosis_{j} = \sum_{i}^{n} \frac{p_i (T_i - Mean_j)^4}{Variance_j^2}
\tag{4}
\]  

where $p_i$ is the relative abundance and $T_i$ the trait value of the species _i_, _n_ is the number of species in a community _j_ with available trait information and the sum of relative abundance is equal to 100% for each community.  

The calculation of all moments provides detailed insights into the precise shape of trait distributions and allows the derived parameters to be linked to established frameworks of functional diversity (Bello et al. 2021, Bagousse-Pinguet et al. 2021) and the filtering concept (Enquist et al. 2015).  


## Installation

Install the latest version from GitHub:

``` r
# install.packages("devtools")
devtools::install_github("SchreinerFR/TraitMoments")
```

## View documentation

Load the package and call the documentation for the function 'trait_moments':

```{r, message=FALSE}
library(TraitMoments)
?trait_moments
```

## Example data

TraitMoments provides two example data frames. The data frame 'communities' contains the abundances for 93 species from 20 communities and 'traits' provides information on seven traits for the corresponding species. For some species, no information is available for certain traits, so the data frame 'traits' contains some NAs. Since both data frames are quite large, we just inspect the heads in this example:

```{r, message=FALSE}
data(trait_moments_data)
communities[1:20,1:5] 
traits[1:6,1:ncol(traits)] 
```

## Example calculations

### First: with default settings

Now we use the function 'trait_moments' to calculate the moments of all trait distributions for each trait and each community. The function will perform the calculation for all 140 combinations of trait and community at once. We just inspect the head of the result:

```{r}
result <- trait_moments(communities, traits)
dim(result)
result[1:20,1:ncol(result)]
```


### Second: with settings to control the trade-off between reliable results and the number of NAs obtained

The first attempt resulted in a data frame that contains several NAs. This is because ‘trait_moments’ with default settings returns an NA  if the cumulative relative abundance of the species for which trait information is available is less than 80% or if there is missing information for at leased one of the four most dominant species. Many studies use a threshold value of 80% cumulative relative abundance for the calculation of community weighted means (Bello et al. 2021). For the calculation of trait distribution moments, Le Bagousse-Pinguet et al. (2017) introduced the additional threshold that, trait data should be available for the four most dominant species to avoid any breaks in the trait distributions. I strongly recommend applying these or even stricter criteria in order to obtain reliable results. However, ‘trait_moments’ contains arguments to control the trade-off between reliable results and the number of NAs obtained. By setting the arguments 'n_species = 1' and 'abundance = 50' we get a result that contains less NAs. 

```{r}
result <- trait_moments(communities, traits, n_species = 1, abundance = 50)
result[1:20,1:ncol(result)]
```

Conversely, the two arguments can also be used to apply stricter quality criteria. This is particularly appropriate when trait information is available for a large number of species. 

## Visualisation of trait distributions based on moments

A function for visualising trait distributions based on the moments is not yet available in ‘TraitMoments’, but I intend to implement it in later versions. Here I show how to visualise trait distributions for single communities using the package 'PearsonDS'. Lets plot the distributions of Trait 1 for Community 1, 5 and 9:

Firstly, select the results for the tree distributions:

```{r}
selected_results <- rbind(
  result[1, 1:ncol(result)],
  result[29, 1:ncol(result)],
  result[57, 1:ncol(result)]
  )
```

Second, density estimation via 'rpearson' and 'density':

```{r, message=FALSE, warning=FALSE}
library(PearsonDS)
set.seed(123)
pearson_generation  <- rpearson(10000000,moments=c(mean = selected_results[1,3], variance = selected_results[1,4], skewness = selected_results[1,5], kurtosis = selected_results[1,6]))
dens_Community.1_Trait.1 <- density(pearson_generation)

pearson_generation  <- rpearson(10000000,moments=c(mean = selected_results[2,3], variance = selected_results[2,4], skewness = selected_results[2,5], kurtosis = selected_results[2,6]))
dens_Community.5_Trait.1 <- density(pearson_generation)

pearson_generation  <- rpearson(10000000,moments=c(mean = selected_results[3,3], variance = selected_results[3,4], skewness = selected_results[3,5], kurtosis = selected_results[3,6]))
dens_Community.9_Trait.1 <- density(pearson_generation)
```

Third, plot the density estimation:

```{r, message=FALSE, warning=FALSE, fig.height = 6, fig.width=4}

par(mfrow = c(3, 1))
plot(dens_Community.1_Trait.1$x,length(dens_Community.1_Trait.1$x)*dens_Community.1_Trait.1$y,type="l",xlab="Value",ylab="Frequency", yaxt='n', main = "Community 1 Trait 1", xlim = c(0,1))
plot(dens_Community.5_Trait.1$x,length(dens_Community.5_Trait.1$x)*dens_Community.5_Trait.1$y,type="l",xlab="Value",ylab="Frequency", yaxt='n', main = "Community 5 Trait 1", xlim = c(0,1))
plot(dens_Community.9_Trait.1$x,length(dens_Community.9_Trait.1$x)*dens_Community.9_Trait.1$y,type="l",xlab="Value",ylab="Frequency", yaxt='n', main = "Community 9 Trait 1", xlim = c(0,1))
```

And inspect the corresponding moments:

```{r}
selected_results
```

The estimated distributions of trait 1 for the three communities look quite different. If we had only calculated the mean values, as is the case in many studies, some of these differences would have remained hidden. As mean and variance are regularly considered in functional ecology studies, I will emphasise how the distributions differ in terms of skewness and kurtosis. Skewness is a measure of the asymmetry of a distribution. Community 1 is strongly skewed to the right (positive skew), while community 5 is slightly skewed to the left (negative skew) and community 9 is almost symmetric (skew close to zero). Furthermore the three distributions differ with regard to the fourth moment, the kurtosis which is a characterization of a distributions “tailedness” or "peakedness". Community 1 is quite peaked  around a value of approximately 0.2, but also has a tail that extends far to the right. Although the distribution for community 5 looks less peaked at first glance, it has the highest kurtosis, as its tails are less pronounced than those of community 1. The distribution for community 9 has the least marked peak and short tails, i.e. a low kurtosis, which in the sense of Le Bagousse-Pinguet et al. (2021) would be indicative for a high functional evenness.


## Final note on community weighted means (CWMs)

The function 'functcomp' from the package 'FD' is frequently used to calculate CWMs. In the following I will demonstrate that ‘functcomp’ and ‘trait_moments’ return exactly the same values, however ‘trait_moments’ enables to specify a threshold for the cumulative relative abundance for which trait information should be present.  

First we inspect the output of 'functcomp':

```{r, message=FALSE, warning=FALSE}
library(FD)
functcomp(traits, as.matrix(communities))
```

As already stated above, in many cases it is advisable to set a threshold value of 80 % for the cumulative relative abundance. This can be achieved via 'trait_moments' if we set 'n_species = 0' and 'abundance = 80':

```{r}
result <- trait_moments(communities, traits, n_species = 0, abundance = 80)
result[1:20,1:ncol(result)]
```

We receive a warning that CWMs but no moments can be calculated if we set 'n_species = 0'. Since this is our goal in this special case we can ignore this warning. 'Trait_moments' generates exactly the same CWMs as 'functcomp', but if there is not suficient trait information to obtain reliable results (level can be chosen by the user), it returns NAs. If we set 'n_species = 0' and 'abundance = 0', the two functions return exactly the same result.

# Citation

Please cite as:

> Falk-Rudhard Schreiner (`r format(Sys.Date(), "%Y")`). TraitMoments: Efficient calculation of trait distribution moments. Online at <https://github.com/SchreinerFR/TraitMoments>.


# References

Bello, F. de, Carmona, C.P., Dias, A.T.C., Götzenberger, L., Moretti, M. & Berg, M.P. (2021) Handbook of Trait-Based Ecology. Cambridge University Press.

Enquist, B.J., Norberg, J., Bonser, S.P., Violle, C., Webb, C.T. & Henderson, A. et al. (2015) Chapter Nine - Scaling from Traits to Ecosystems: Developing a General Trait Driver Theory via Integrating Trait-Based and Metabolic Scaling Theories. In: Pawar, S., Woodward, G. & Dell, A.I. (Eds.) Trait-Based Ecology - From Structure to Function. Academic Press.

Le Bagousse-Pinguet, Y., Gross, N., Maestre, F.T., Maire, V., Bello, F. de & Fonseca, C.R. et al. (2017) Testing the environmental filtering concept in global drylands. Journal of Ecology, 105(4), 1058–1069. Available from: https://doi.org/10.1111/1365-2745.12735.

Le Bagousse-Pinguet, Y., Gross, N., Saiz, H., Maestre, F.T., Ruiz, S. & Dacal, M. et al. (2021) Functional rarity and evenness are key facets of biodiversity to boost multifunctionality. Proceedings of the National Academy of Sciences of the United States of America, 118(7). Available from: https://doi.org/10.1073/pnas.2019355118.


